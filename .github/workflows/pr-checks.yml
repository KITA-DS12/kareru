name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check PR title format
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|clean)(\(.+\))?: ]]; then
          echo "‚ùå PR title must follow Conventional Commits format"
          echo "Examples: feat: add new feature, fix: resolve bug, docs: update readme"
          exit 1
        fi
        echo "‚úÖ PR title format is valid"
    
    - name: Check for required PR template sections
      run: |
        PR_BODY="${{ github.event.pull_request.body }}"
        
        # Check for required sections
        if [[ ! "$PR_BODY" =~ "## Ê¶ÇË¶Å" ]]; then
          echo "‚ùå PR body must include '## Ê¶ÇË¶Å' section"
          exit 1
        fi
        
        if [[ ! "$PR_BODY" =~ "## Â§âÊõ¥Á®ÆÂà•" ]]; then
          echo "‚ùå PR body must include '## Â§âÊõ¥Á®ÆÂà•' section"
          exit 1
        fi
        
        if [[ ! "$PR_BODY" =~ "## Â§âÊõ¥ÂÜÖÂÆπ" ]]; then
          echo "‚ùå PR body must include '## Â§âÊõ¥ÂÜÖÂÆπ' section"
          exit 1
        fi
        
        echo "‚úÖ PR template sections are present"

  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check file count in PR
      run: |
        FILES_CHANGED=$(git diff --name-only origin/main...HEAD | wc -l)
        echo "Files changed: $FILES_CHANGED"
        
        if [ "$FILES_CHANGED" -gt 10 ]; then
          echo "‚ö†Ô∏è Warning: PR changes more than 10 files ($FILES_CHANGED files)"
          echo "Consider breaking this into smaller PRs for easier review"
        else
          echo "‚úÖ File count is reasonable"
        fi
        
    - name: Check diff size
      run: |
        DIFF_SIZE=$(git diff --stat origin/main...HEAD | tail -n 1 | grep -o '[0-9]\+ insertions\|[0-9]\+ deletions' | grep -o '[0-9]\+' | paste -sd+ | bc || echo "0")
        echo "Diff size: $DIFF_SIZE lines"
        
        if [ "$DIFF_SIZE" -gt 400 ]; then
          echo "‚ö†Ô∏è Warning: PR has large diff ($DIFF_SIZE lines)"
          echo "Consider breaking this into smaller PRs for easier review"
        else
          echo "‚úÖ Diff size is reasonable"
        fi

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Scan for secrets
      run: |
        # Basic secret pattern detection
        echo "üîç Scanning for potential secrets..."
        
        # Check for common secret patterns
        if grep -r -i "password\s*=\s*['\"][^'\"]*['\"]" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "‚ùå Potential hardcoded password found"
          exit 1
        fi
        
        if grep -r -i "api[_-]key\s*=\s*['\"][^'\"]*['\"]" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "‚ùå Potential API key found"
          exit 1
        fi
        
        if grep -r -i "secret\s*=\s*['\"][^'\"]*['\"]" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "‚ùå Potential secret found"
          exit 1
        fi
        
        echo "‚úÖ No obvious secrets detected"